<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nest | 我的文档地址</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="在线文档地址">
    
    <link rel="preload" href="/vue-preess/assets/css/0.styles.a7b65f9e.css" as="style"><link rel="preload" href="/vue-preess/assets/js/app.19476c11.js" as="script"><link rel="preload" href="/vue-preess/assets/js/2.f3b333de.js" as="script"><link rel="preload" href="/vue-preess/assets/js/1.f574d6f5.js" as="script"><link rel="preload" href="/vue-preess/assets/js/34.c2d25fb7.js" as="script"><link rel="prefetch" href="/vue-preess/assets/js/10.1f88676b.js"><link rel="prefetch" href="/vue-preess/assets/js/11.55ba53f7.js"><link rel="prefetch" href="/vue-preess/assets/js/12.ce5c7d6f.js"><link rel="prefetch" href="/vue-preess/assets/js/13.1ee92742.js"><link rel="prefetch" href="/vue-preess/assets/js/14.ccf0f713.js"><link rel="prefetch" href="/vue-preess/assets/js/15.b9ea491a.js"><link rel="prefetch" href="/vue-preess/assets/js/16.4ad6e081.js"><link rel="prefetch" href="/vue-preess/assets/js/17.a554319d.js"><link rel="prefetch" href="/vue-preess/assets/js/18.f5513c91.js"><link rel="prefetch" href="/vue-preess/assets/js/19.17eb6035.js"><link rel="prefetch" href="/vue-preess/assets/js/20.2f27fd7b.js"><link rel="prefetch" href="/vue-preess/assets/js/21.bc813914.js"><link rel="prefetch" href="/vue-preess/assets/js/22.960cb455.js"><link rel="prefetch" href="/vue-preess/assets/js/23.033014fe.js"><link rel="prefetch" href="/vue-preess/assets/js/24.9926cf9a.js"><link rel="prefetch" href="/vue-preess/assets/js/25.1697aa0f.js"><link rel="prefetch" href="/vue-preess/assets/js/26.c4b1dabd.js"><link rel="prefetch" href="/vue-preess/assets/js/27.a545f9cb.js"><link rel="prefetch" href="/vue-preess/assets/js/28.8504d86f.js"><link rel="prefetch" href="/vue-preess/assets/js/29.e9e58762.js"><link rel="prefetch" href="/vue-preess/assets/js/3.024324e3.js"><link rel="prefetch" href="/vue-preess/assets/js/30.63ef17be.js"><link rel="prefetch" href="/vue-preess/assets/js/31.510bf205.js"><link rel="prefetch" href="/vue-preess/assets/js/32.dc0d5f0b.js"><link rel="prefetch" href="/vue-preess/assets/js/33.5bbba8e8.js"><link rel="prefetch" href="/vue-preess/assets/js/35.f999ee97.js"><link rel="prefetch" href="/vue-preess/assets/js/36.227d6bcd.js"><link rel="prefetch" href="/vue-preess/assets/js/37.75f2b4fe.js"><link rel="prefetch" href="/vue-preess/assets/js/38.1b42442b.js"><link rel="prefetch" href="/vue-preess/assets/js/39.25bccaaf.js"><link rel="prefetch" href="/vue-preess/assets/js/4.4a252247.js"><link rel="prefetch" href="/vue-preess/assets/js/40.159143f5.js"><link rel="prefetch" href="/vue-preess/assets/js/41.d603584d.js"><link rel="prefetch" href="/vue-preess/assets/js/42.ef442d3a.js"><link rel="prefetch" href="/vue-preess/assets/js/43.f7130bae.js"><link rel="prefetch" href="/vue-preess/assets/js/44.24cbf576.js"><link rel="prefetch" href="/vue-preess/assets/js/45.bc0671c8.js"><link rel="prefetch" href="/vue-preess/assets/js/46.b8e4cd12.js"><link rel="prefetch" href="/vue-preess/assets/js/47.4b2b7cb1.js"><link rel="prefetch" href="/vue-preess/assets/js/5.0aba521d.js"><link rel="prefetch" href="/vue-preess/assets/js/6.ef6a8bc7.js"><link rel="prefetch" href="/vue-preess/assets/js/7.d99d4d7f.js"><link rel="prefetch" href="/vue-preess/assets/js/vendors~docsearch.bdc2fb18.js">
    <link rel="stylesheet" href="/vue-preess/assets/css/0.styles.a7b65f9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-preess/" class="home-link router-link-active"><!----> <span class="site-name">我的文档地址</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-preess/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          EcmaScript标准语法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/reg.html" class="nav-link">
  正则
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/arr.html" class="nav-link">
  数组
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/object.html" class="nav-link">
  对象
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/str.html" class="nav-link">
  字符串
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/promise.html" class="nav-link">
  promise
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/this.html" class="nav-link">
  this指向
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/prototype.html" class="nav-link">
  原型链
</a></li></ul></li><li class="dropdown-item"><h4>
          WebApi
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-preess/base/WebApi/window.html" class="nav-link">
  api记录
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/WebApi/css.html" class="nav-link">
  css新特性
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="跨端" class="dropdown-title"><span class="title">跨端</span> <span class="arrow down"></span></button> <button type="button" aria-label="跨端" class="mobile-dropdown-title"><span class="title">跨端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/cross/uniApp.html" class="nav-link">
  uniApp
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/cross/electron.html" class="nav-link">
  electron
</a></li></ul></div></div><div class="nav-item"><a href="/vue-preess/plugin/plugin.html" class="nav-link">
  常用插件
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用配置" class="dropdown-title"><span class="title">常用配置</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用配置" class="mobile-dropdown-title"><span class="title">常用配置</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/config/vite-config.html" class="nav-link">
  vite常用配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/tailwindcss.html" class="nav-link">
  tailwindcss的配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/nodemon.html" class="nav-link">
  nodemon配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/vscode.html" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/monorepo.html" class="nav-link">
  monorepo
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/prisma.html" class="nav-link">
  prisma
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/three.html" class="nav-link">
  three
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/nest.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  nest
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow down"></span></button> <button type="button" aria-label="node" class="mobile-dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/node/node.html" class="nav-link">
  node知识
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题库" class="dropdown-title"><span class="title">题库</span> <span class="arrow down"></span></button> <button type="button" aria-label="题库" class="mobile-dropdown-title"><span class="title">题库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/question/base.html" class="nav-link">
  基础问题
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/question/AI.html" class="nav-link">
  AI
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/question/langchain.html" class="nav-link">
  langchain
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-preess/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          EcmaScript标准语法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/reg.html" class="nav-link">
  正则
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/arr.html" class="nav-link">
  数组
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/object.html" class="nav-link">
  对象
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/str.html" class="nav-link">
  字符串
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/promise.html" class="nav-link">
  promise
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/this.html" class="nav-link">
  this指向
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/EcmaScript/prototype.html" class="nav-link">
  原型链
</a></li></ul></li><li class="dropdown-item"><h4>
          WebApi
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-preess/base/WebApi/window.html" class="nav-link">
  api记录
</a></li><li class="dropdown-subitem"><a href="/vue-preess/base/WebApi/css.html" class="nav-link">
  css新特性
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="跨端" class="dropdown-title"><span class="title">跨端</span> <span class="arrow down"></span></button> <button type="button" aria-label="跨端" class="mobile-dropdown-title"><span class="title">跨端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/cross/uniApp.html" class="nav-link">
  uniApp
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/cross/electron.html" class="nav-link">
  electron
</a></li></ul></div></div><div class="nav-item"><a href="/vue-preess/plugin/plugin.html" class="nav-link">
  常用插件
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用配置" class="dropdown-title"><span class="title">常用配置</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用配置" class="mobile-dropdown-title"><span class="title">常用配置</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/config/vite-config.html" class="nav-link">
  vite常用配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/tailwindcss.html" class="nav-link">
  tailwindcss的配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/nodemon.html" class="nav-link">
  nodemon配置
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/vscode.html" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/monorepo.html" class="nav-link">
  monorepo
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/prisma.html" class="nav-link">
  prisma
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/three.html" class="nav-link">
  three
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/config/nest.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  nest
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow down"></span></button> <button type="button" aria-label="node" class="mobile-dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/node/node.html" class="nav-link">
  node知识
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题库" class="dropdown-title"><span class="title">题库</span> <span class="arrow down"></span></button> <button type="button" aria-label="题库" class="mobile-dropdown-title"><span class="title">题库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue-preess/question/base.html" class="nav-link">
  基础问题
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/question/AI.html" class="nav-link">
  AI
</a></li><li class="dropdown-item"><!----> <a href="/vue-preess/question/langchain.html" class="nav-link">
  langchain
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vue-preess/config/vite-config.html" class="sidebar-link">vite常用配置</a></li><li><a href="/vue-preess/config/tailwindcss.html" class="sidebar-link">tailwindcss</a></li><li><a href="/vue-preess/config/nodemon.html" class="sidebar-link">nodemon 配置</a></li><li><a href="/vue-preess/config/git.html" class="sidebar-link">git常用命令</a></li><li><a href="/vue-preess/config/vscode.html" class="sidebar-link">vscode 快捷命令</a></li><li><a href="/vue-preess/config/monorepo.html" class="sidebar-link">多包管理</a></li><li><a href="/vue-preess/config/prisma.html" class="sidebar-link">prisma</a></li><li><a href="/vue-preess/config/three.html" class="sidebar-link">three</a></li><li><a href="/vue-preess/config/nest.html" aria-current="page" class="active sidebar-link">nest</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#什么是-nest-js" class="sidebar-link">什么是 nest.js</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#鉴权" class="sidebar-link">鉴权</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#创建-token" class="sidebar-link">创建 token</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#路由守卫" class="sidebar-link">路由守卫</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#局部守卫" class="sidebar-link">局部守卫</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#前端配合" class="sidebar-link">前端配合</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#表单验证" class="sidebar-link">表单验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#dto" class="sidebar-link">dto</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#验证数据唯一性" class="sidebar-link">验证数据唯一性</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#minio" class="sidebar-link">minio</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#安装-minio" class="sidebar-link">安装 MinIO</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#密钥生成" class="sidebar-link">密钥生成</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#删除-bucket" class="sidebar-link">删除 Bucket</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#使用密钥" class="sidebar-link">使用密钥</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#ai" class="sidebar-link">ai</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#安装包下载" class="sidebar-link">安装包下载</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#初始化" class="sidebar-link">初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#在服务中使用" class="sidebar-link">在服务中使用</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#在控制层" class="sidebar-link">在控制层</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#前端配合-2" class="sidebar-link">前端配合</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#深度思考" class="sidebar-link">深度思考</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#联网" class="sidebar-link">联网</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#使用深度思考和联网之后服务代码的更改" class="sidebar-link">使用深度思考和联网之后服务代码的更改</a></li><li class="sidebar-sub-header"><a href="/vue-preess/config/nest.html#更改之后控制层的修改" class="sidebar-link">更改之后控制层的修改</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nest"><a href="#nest" class="header-anchor">#</a> nest</h1> <h2 id="什么是-nest-js"><a href="#什么是-nest-js" class="header-anchor">#</a> 什么是 nest.js</h2> <p>Nest.js 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的框架。它基于 TypeScript 并结合了 Angular 的架构模式，提供了一种结构化的方式来开发应用程序。</p> <h2 id="鉴权"><a href="#鉴权" class="header-anchor">#</a> 鉴权</h2> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token function">pnpm</span> <span class="token function">install</span> @nestjs/jwt
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module<span class="token punctuation">,</span> Global <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/config&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Global</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>JwtModule<span class="token punctuation">,</span> ConfigModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      isGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      envFilePath<span class="token operator">:</span> <span class="token string">&quot;.env&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
      inject<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        secret<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">&quot;1d&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SharedModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="创建-token"><a href="#创建-token" class="header-anchor">#</a> 创建 token</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./auth.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SharedModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@libs/shared&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>SharedModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code>AuthService 实现生成token<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Token<span class="token punctuation">,</span> TokenPayload<span class="token punctuation">,</span> RefreshToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@en/common/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/jwt&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> jwtService<span class="token operator">:</span> JwtService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">generateToken</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> TokenPayload<span class="token punctuation">)</span><span class="token operator">:</span> Token <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      accessToken<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">sign</span><span class="token generic class-name"><span class="token operator">&lt;</span>RefreshToken<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>payload<span class="token punctuation">,</span>
        tokenType<span class="token operator">:</span> <span class="token string">&quot;access&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      refreshToken<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">sign</span><span class="token generic class-name"><span class="token operator">&lt;</span>RefreshToken<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          <span class="token operator">...</span>payload<span class="token punctuation">,</span>
          tokenType<span class="token operator">:</span> <span class="token string">&quot;refresh&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          expiresIn<span class="token operator">:</span> <span class="token string">&quot;7d&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="路由守卫"><a href="#路由守卫" class="header-anchor">#</a> 路由守卫</h2> <div class="language-bash extra-class"><pre class="language-bash"><code> 创建一个守卫模块
 nest g guard auth
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code>这是全局守卫<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  CanActivate<span class="token punctuation">,</span>
  ExecutionContext<span class="token punctuation">,</span>
  Injectable<span class="token punctuation">,</span>
  UnauthorizedException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rxjs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RefreshToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@en/common/user&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanActivate</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> jwtService<span class="token operator">:</span> JwtService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">canActivate</span><span class="token punctuation">(</span>
    context<span class="token operator">:</span> ExecutionContext<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Observable<span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span>authorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">&quot;别偷了哥,买点东西吧&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> headers<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">verify</span><span class="token generic class-name"><span class="token operator">&lt;</span>RefreshToken<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>tokenType <span class="token operator">!==</span> <span class="token string">&quot;access&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">&quot;token类型错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      request<span class="token punctuation">.</span>user <span class="token operator">=</span> payload<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token string">&quot;token 失效了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="局部守卫"><a href="#局部守卫" class="header-anchor">#</a> 局部守卫</h2> <div class="language-ts extra-class"><pre class="language-ts"><code>在app<span class="token punctuation">.</span>module<span class="token punctuation">.</span>ts 中引入守卫模块<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/config'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      isGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      envFilePath<span class="token operator">:</span> <span class="token string">'.env'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;passport-jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ExtractJwt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;passport-jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/passport&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PrismaService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../prisma-util/prisma-util.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">,</span> <span class="token string">&quot;jwt&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>configService<span class="token operator">:</span> ConfigService<span class="token punctuation">,</span> <span class="token keyword">private</span> prisma<span class="token operator">:</span> PrismaService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token operator">:</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromAuthHeaderAsBearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      secretOrKey<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userId <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findUnique</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> userId<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Body<span class="token punctuation">,</span> Req<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./auth.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RegisterDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./dto/auto-register.dot&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoginDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./dto/auth-login.dot&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/passport&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">&quot;jwt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">getAll</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Req</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="前端配合"><a href="#前端配合" class="header-anchor">#</a> 前端配合</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Token <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@en/common/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../index.ts&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> refreshServer <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token operator">:</span> <span class="token string">&quot;/api/v1&quot;</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

refreshServer<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> refreshTokenApi <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> Omit<span class="token operator">&lt;</span>Token<span class="token punctuation">,</span> <span class="token string">&quot;accessToken&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> refreshServer<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/user/refresh-token&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>
    Response<span class="token operator">&lt;</span>Token<span class="token operator">&gt;</span>
  <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> serverApi <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token operator">:</span> <span class="token string">&quot;/api/v1&quot;</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token constant">TIMEOUT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建锁</span>
<span class="token keyword">let</span> isRefreshing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 创建失败的队列</span>
<span class="token keyword">let</span> requestQueue<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newAccessToken<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 请求拦截</span>
serverApi<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">userStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>getAccessToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>getAccessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 响应拦截</span>
serverApi<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">userStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> accessToken <span class="token operator">=</span> user<span class="token punctuation">.</span>getAccessToken<span class="token punctuation">;</span>
      <span class="token keyword">const</span> refreshToken <span class="token operator">=</span> user<span class="token punctuation">.</span>getRefreshToken<span class="token punctuation">;</span>
      <span class="token keyword">const</span> originalRequest <span class="token operator">=</span> error<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>accessToken <span class="token operator">||</span> <span class="token operator">!</span>refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ElMessage<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;没有任何token,无法刷新，请重新登录  &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">loginOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRefreshing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 加入队列</span>
          requestQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>newAccessToken<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            originalRequest<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newAccessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">serverApi</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      isRefreshing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">refreshTokenApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span> refreshToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newToken<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          user<span class="token punctuation">.</span><span class="token function">updateToken</span><span class="token punctuation">(</span>newToken<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          user<span class="token punctuation">.</span><span class="token function">loginOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        requestQueue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>newToken<span class="token punctuation">.</span>data<span class="token punctuation">.</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">serverApi</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        requestQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        isRefreshing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="表单验证"><a href="#表单验证" class="header-anchor">#</a> 表单验证</h2> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token function">pnpm</span> <span class="token function">add</span> class-validator class-transformer
</code></pre></div><h3 id="dto"><a href="#dto" class="header-anchor">#</a> dto</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IsNotEmpty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;class-validator&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 这是dto</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoginDto</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">IsNotEmpty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;用户名不能为空&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">IsNotEmpty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;密码不能为空&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token comment">// 这是controller的代码</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
  <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> loginDto<span class="token operator">:</span> LoginDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>loginDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  在去main<span class="token punctuation">.</span>ts中写全局过滤器

   app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="验证数据唯一性"><a href="#验证数据唯一性" class="header-anchor">#</a> 验证数据唯一性</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> PrismaService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../prisma-util/prisma-util.service&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  registerDecorator<span class="token punctuation">,</span>
  ValidationArguments<span class="token punctuation">,</span>
  ValidationOptions<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;class-validator&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 表单字段是否唯一</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isNotExistsRule</span><span class="token punctuation">(</span>
  table<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  validationOptions<span class="token operator">:</span> ValidationOptions<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>object<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> propertyName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerDecorator</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&quot;isNotExistsRule&quot;</span><span class="token punctuation">,</span>
      target<span class="token operator">:</span> object<span class="token punctuation">.</span>constructor<span class="token punctuation">,</span>
      propertyName<span class="token punctuation">,</span>
      options<span class="token operator">:</span> validationOptions<span class="token punctuation">,</span>
      validator<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">validate</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> args<span class="token operator">:</span> ValidationArguments<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prismaService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrismaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> prismaService<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token punctuation">[</span>args<span class="token punctuation">.</span>property<span class="token punctuation">]</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">Boolean</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="minio"><a href="#minio" class="header-anchor">#</a> minio</h2> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token function">pnpm</span> <span class="token function">add</span>  minio
 <span class="token function">pnpm</span> <span class="token function">add</span>  @types/multer <span class="token parameter variable">-D</span>
</code></pre></div><h3 id="安装-minio"><a href="#安装-minio" class="header-anchor">#</a> 安装 MinIO</h3> <p>打开网址：<code>https://minio.org.cn/download.shtml#/windows</code></p> <ol><li>下载 server -&gt; minio.exe</li> <li>下载 client -&gt; mc.exe</li></ol> <p>两个都要下载，下载完成之后放入文件夹即可,在文件夹里面新建两个文件名字可以随便取，我这儿叫<code>minio-data</code> <code>minio-data2</code>。进行集群存储，方便数据备份。</p> <p>windows CMD 命令行启动</p> <p>新建一个文件<code>start.cmd</code></p> <div class="language-cmd extra-class"><pre class="language-text"><code>set MINIO_ROOT_USER=admin
set MINIO_ROOT_PASSWORD=12345678
minio.exe server .\minio-data .\minio-data2 --console-address &quot;:9001&quot;
</code></pre></div><h3 id="密钥生成"><a href="#密钥生成" class="header-anchor">#</a> 密钥生成</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>前置 <span class="token function">mc</span> <span class="token builtin class-name">alias</span> <span class="token builtin class-name">set</span> myminio http://localhost:9000 admin <span class="token number">12345678</span>
<span class="token function">mc</span> admin user svcacct <span class="token function">add</span> myminio admin
</code></pre></div><h3 id="删除-bucket"><a href="#删除-bucket" class="header-anchor">#</a> 删除 Bucket</h3> <div class="language- extra-class"><pre class="language-text"><code>mc rb --force myminio/avatar
</code></pre></div><h3 id="使用密钥"><a href="#使用密钥" class="header-anchor">#</a> 使用密钥</h3> <div class="language-json extra-class"><pre class="language-json"><code>
# minio access秘钥
MINIO_ACCESS_KEY=<span class="token string">&quot;OZ0Q833E5RPMFALGKKXT&quot;</span>
# minio secret秘钥
MINIO_SECRET_KEY=<span class="token string">&quot;deW1+xXBiCI6ep6BvUpUJQxfxbJjhCLoWiPPBgWd&quot;</span>
# minio 地址
MINIO_URL=<span class="token string">&quot;192.168.101.32&quot;</span>
# minio 端口
MINIO_PORT=<span class="token number">9000</span>
# 是否使用SSL
MINIO_USE_SSL=<span class="token number">0</span>
# minio 桶名
MINIO_BUCKET=<span class="token string">&quot;avatar&quot;</span>

</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//  自己创建service和module</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> OnModuleInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Minio <span class="token keyword">from</span> <span class="token string">&quot;minio&quot;</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MinioService</span> <span class="token keyword">implements</span> <span class="token class-name">OnModuleInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> minioClient<span class="token operator">:</span> Minio<span class="token punctuation">.</span>Client<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> configService<span class="token operator">:</span> ConfigService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>minioClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Minio</span><span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      endPoint<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_URL&quot;</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_PORT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      useSSL<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_USE_SSL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      accessKey<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_ACCESS_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      secretKey<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_SECRET_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 读取桶命</span>
    <span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否存在</span>
    <span class="token keyword">const</span> bucketExists <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bucketExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建桶</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置桶策略</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minioClient<span class="token punctuation">.</span><span class="token function">setBucketPolicy</span><span class="token punctuation">(</span>
        bucket<span class="token punctuation">,</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          Version<span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
          Statement<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              Sid<span class="token operator">:</span> <span class="token string">&quot;PublicReadObjects&quot;</span><span class="token punctuation">,</span> <span class="token comment">//给这个规则起一个名字</span>
              Effect<span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span> <span class="token comment">//允许打开这个规则 Allow 允许 Deny 拒绝</span>
              Principal<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token comment">//所有人</span>
              Action<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//允许浏览器获取对象</span>
              Resource<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;arn:aws:s3:::avatar/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//允许读取 avatar桶内的所有资源</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minioClient<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;MINIO_BUCKET&quot;</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ai"><a href="#ai" class="header-anchor">#</a> ai</h2> <h3 id="安装包下载"><a href="#安装包下载" class="header-anchor">#</a> 安装包下载</h3> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token function">pnpm</span> <span class="token function">add</span>  @langchain/core  @langchain/deepseek @langchain/langgraph @langchain/langgraph-checkpoint-postgres langchain
</code></pre></div><h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 初始化deepSeek模型</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChatDeepSeek <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@langchain/deepseek&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostgresSaver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@langchain/langgraph-checkpoint-postgres&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createDeepSeek</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> apiKey <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;DEEPSEEK_API_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> model <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;DEEPSEEK_API_MODEL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">ChatDeepSeek</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    apiKey<span class="token punctuation">,</span>
    model<span class="token punctuation">,</span>
    maxTokens<span class="token operator">:</span> <span class="token number">4399</span><span class="token punctuation">,</span>
    streaming<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启流式输出</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化存储</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createCheckPoint</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dbUrl <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;POSTGRES_URL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> checkpointer <span class="token operator">=</span> PostgresSaver<span class="token punctuation">.</span><span class="token function">fromConnString</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> checkpointer<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> checkpointer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在服务中使用"><a href="#在服务中使用" class="header-anchor">#</a> 在服务中使用</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> chatMode <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    role<span class="token operator">:</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span> <span class="token comment">//角色</span>
    prompt<span class="token operator">:</span>
      <span class="token string">&quot;你是一个智能助手，这是一个学英语的对话，根据用户的对话内容，给出相应的回答(使用简单易懂的表达)，请用中文回答&quot;</span><span class="token punctuation">,</span>
    label<span class="token operator">:</span> <span class="token string">&quot;💬 智能助手&quot;</span><span class="token punctuation">,</span> <span class="token comment">//标签</span>
    id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token comment">//id</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    role<span class="token operator">:</span> <span class="token string">&quot;master&quot;</span><span class="token punctuation">,</span>
    prompt<span class="token operator">:</span>
      <span class="token string">&quot;你是一个英语大师，这是一个英语学习的对话，根据用户的对话内容，给出相应的回答(使用专业术语)，请用英文回答&quot;</span><span class="token punctuation">,</span>
    label<span class="token operator">:</span> <span class="token string">&quot;🎓 英语大师&quot;</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    role<span class="token operator">:</span> <span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span>
    prompt<span class="token operator">:</span>
      <span class="token string">&quot;你是一个商务英语专家，这是一个商务英语的对话，根据用户的对话内容，给出相应的回答(使用商务英语专业术语)，请用中文回答&quot;</span><span class="token punctuation">,</span>
    label<span class="token operator">:</span> <span class="token string">&quot;💼 商务英语&quot;</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// chatMode 这个是模型列表</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> chatMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./../prompt/prompt.model&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> OnModuleInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createDeepSeek<span class="token punctuation">,</span> createCheckpoint <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../llm/llm.config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostgresSaver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@langchain/langgraph-checkpoint-postgres&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ChatDto<span class="token punctuation">,</span> ChatRoleType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@en/common/chat&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> AIMessageChunk<span class="token punctuation">,</span> ReactAgent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createAgent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ResponseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@libs/shared&quot;</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChatService</span> <span class="token keyword">implements</span> <span class="token class-name">OnModuleInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> checkpointer<span class="token operator">:</span> PostgresSaver<span class="token punctuation">;</span>
  <span class="token keyword">private</span> agents<span class="token operator">:</span> Map<span class="token operator">&lt;</span>ChatRoleType<span class="token punctuation">,</span> ReactAgent<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> responseService<span class="token operator">:</span> ResponseService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始话</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化多个agent</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mode <span class="token keyword">of</span> chatMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> agent <span class="token operator">=</span> <span class="token function">createAgent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        model<span class="token operator">:</span> <span class="token function">createDeepSeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        systemPrompt<span class="token operator">:</span> mode<span class="token punctuation">.</span>prompt<span class="token punctuation">,</span>
        checkpointer<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>agents<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mode<span class="token punctuation">.</span>role<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">streamCompletion</span><span class="token punctuation">(</span>createChatDto<span class="token operator">:</span> ChatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> agent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>agents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>createChatDto<span class="token punctuation">.</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>agent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Agent for role </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> threadId <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> agent<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        messages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> createChatDto<span class="token punctuation">.</span>content <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        configurable<span class="token operator">:</span> <span class="token punctuation">{</span>
          thread_id<span class="token operator">:</span> threadId<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        streamMode<span class="token operator">:</span> <span class="token string">&quot;messages&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stream<span class="token punctuation">;</span> <span class="token comment">// 这是个迭代器，需要在controller中处理</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取历史记录</span>
  <span class="token keyword">async</span> <span class="token function">getHistory</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> role<span class="token operator">:</span> ChatRoleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      configurable<span class="token operator">:</span> <span class="token punctuation">{</span> thread_id<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> messages<span class="token operator">?.</span>channel_values<span class="token operator">?.</span>messages <span class="token keyword">as</span> AIMessageChunk<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseService<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseService<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>
      list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token operator">:</span> item<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        role<span class="token operator">:</span> item<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="在控制层"><a href="#在控制层" class="header-anchor">#</a> 在控制层</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Body<span class="token punctuation">,</span> Res<span class="token punctuation">,</span> Query <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChatService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./chat.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ChatDto<span class="token punctuation">,</span> ChatRoleType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@en/common/chat'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'chat'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChatController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> chatService<span class="token operator">:</span> ChatService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createChatDto<span class="token operator">:</span> ChatDto<span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Res</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 流式传输的MIME类型</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> <span class="token string">'no-cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁用缓存</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Connection'</span><span class="token punctuation">,</span> <span class="token string">'keep-alive'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保持连接</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chatService<span class="token punctuation">.</span><span class="token function">streamCompletion</span><span class="token punctuation">(</span>createChatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>msg<span class="token punctuation">]</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">content</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">'ai'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'history'</span><span class="token punctuation">)</span>
  <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">)</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'role'</span><span class="token punctuation">)</span> role<span class="token operator">:</span> ChatRoleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chatService<span class="token punctuation">.</span><span class="token function">getHistory</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> role<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="前端配合-2"><a href="#前端配合-2" class="header-anchor">#</a> 前端配合</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> deepThink<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> webSearch<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
    list<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        role<span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> message<span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    list<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        role<span class="token operator">:</span> <span class="token string">&quot;ai&quot;</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        reasoning<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token generic-function"><span class="token function">sse</span><span class="token generic class-name"><span class="token operator">&lt;</span>ChatMessage<span class="token punctuation">,</span> ChatDto<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token constant">CHAT_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        role<span class="token operator">:</span> active<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        content<span class="token operator">:</span> message<span class="token punctuation">,</span>
        userId<span class="token operator">:</span> userInstance<span class="token punctuation">.</span>user<span class="token operator">!</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        deepThink<span class="token punctuation">,</span>
        webSearch<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> last <span class="token operator">=</span> list<span class="token punctuation">.</span>value<span class="token punctuation">[</span>list<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'reasoning'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                last<span class="token punctuation">.</span>reasoning <span class="token operator">+=</span> data<span class="token punctuation">.</span>content
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'chat'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                last<span class="token punctuation">.</span>content <span class="token operator">+=</span> data<span class="token punctuation">.</span>content
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Method <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CHAT_URL</span> <span class="token operator">=</span> <span class="token string">&quot;/ai/v1/chat&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchEventSource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@microsoft/fetch-event-source&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> sse <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> Method<span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">,</span>
  callback<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  errorCallback<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">fetchEventSource</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> method<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onmessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      callback<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onerror</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      errorCallback<span class="token operator">?.</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="深度思考"><a href="#深度思考" class="header-anchor">#</a> 深度思考</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createDeepSeekReasoner</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> apiKey <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;DEEPSEEK_API_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将模型更换</span>
  <span class="token comment">//DEEPSEEK_REASONER_API_MODEL=&quot;deepseek-reasoner&quot;</span>
  <span class="token keyword">const</span> model <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;DEEPSEEK_REASONER_API_MODEL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChatDeepSeek</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    apiKey<span class="token punctuation">,</span>
    model<span class="token punctuation">,</span>
    temperature<span class="token operator">:</span> <span class="token number">1.3</span><span class="token punctuation">,</span>
    maxTokens<span class="token operator">:</span> <span class="token number">18000</span><span class="token punctuation">,</span>
    streaming<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启流式输出</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="联网"><a href="#联网" class="header-anchor">#</a> 联网</h3> <div class="language-ts extra-class"><pre class="language-ts"><code>
## 博查服务地址
<span class="token constant">BOCHA_SEARCH_URL</span><span class="token operator">=</span><span class="token string">&quot;https://api.bochaai.com/v1/web-search&quot;</span>
## 博查api key
<span class="token constant">BOCHA_API_KEY</span><span class="token operator">=</span><span class="token string">&quot;sk-abce35bd3d5141c9804adbd27c674aba&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createBoChaSearch</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>query<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> boChaUrl <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'BOCHA_SEARCH_URL'</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>boChaUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>configService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'BOCHA_API_KEY'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      query<span class="token punctuation">,</span>
      count<span class="token punctuation">,</span>
      summary<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否返回长文本摘要</span>
      freshness<span class="token operator">:</span> <span class="token string">'noLimit'</span><span class="token punctuation">,</span> <span class="token comment">// 是否返回结果 freshness 字段</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> values <span class="token operator">=</span> data<span class="token punctuation">.</span>webPages<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">const</span> prompt <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    标题: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    链接: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    摘要: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token operator">?.</span>summary<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    网站名称: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>siteName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    网站logo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>siteIcon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    发布时间: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>dateLastCrawled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> prompt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="使用深度思考和联网之后服务代码的更改"><a href="#使用深度思考和联网之后服务代码的更改" class="header-anchor">#</a> 使用深度思考和联网之后服务代码的更改</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> chatMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./../prompt/prompt.model'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> OnModuleInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  createDeepSeek<span class="token punctuation">,</span>
  createCheckpoint<span class="token punctuation">,</span>
  createBoChaSearch<span class="token punctuation">,</span>
  createDeepSeekReasoner<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../llm/llm.config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostgresSaver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@langchain/langgraph-checkpoint-postgres'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ChatDto<span class="token punctuation">,</span> ChatRoleType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@en/common/chat'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> AIMessageChunk<span class="token punctuation">,</span> ReactAgent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'langchain'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createAgent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'langchain'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ResponseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@libs/shared'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChatService</span> <span class="token keyword">implements</span> <span class="token class-name">OnModuleInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> checkpointer<span class="token operator">:</span> PostgresSaver<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> responseService<span class="token operator">:</span> ResponseService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始话</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">streamCompletion</span><span class="token punctuation">(</span>createChatDto<span class="token operator">:</span> ChatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> prompt <span class="token operator">=</span> chatMode<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>role <span class="token operator">===</span> createChatDto<span class="token punctuation">.</span>role<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">?.</span>prompt<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prompt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Prompt for role </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>createChatDto<span class="token punctuation">.</span>webSearch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> webSearchPrompt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createBoChaSearch</span><span class="token punctuation">(</span>createChatDto<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      prompt <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请根据以下搜索结果回答问题：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webSearchPrompt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(并且返回你参考的网站名称)，用户问题：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> model <span class="token operator">=</span> <span class="token function">createDeepSeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>createChatDto<span class="token punctuation">.</span>deepThink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      model <span class="token operator">=</span> <span class="token function">createDeepSeekReasoner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> agent <span class="token operator">=</span> <span class="token function">createAgent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      model<span class="token punctuation">,</span>
      systemPrompt<span class="token operator">:</span> prompt<span class="token punctuation">,</span>
      checkpointer<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> threadId <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createChatDto<span class="token punctuation">.</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> agent<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        messages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token string">'human'</span><span class="token punctuation">,</span> content<span class="token operator">:</span> createChatDto<span class="token punctuation">.</span>content <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        configurable<span class="token operator">:</span> <span class="token punctuation">{</span>
          thread_id<span class="token operator">:</span> threadId<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        streamMode<span class="token operator">:</span> <span class="token string">'messages'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stream<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">getHistory</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> role<span class="token operator">:</span> ChatRoleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkpointer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      configurable<span class="token operator">:</span> <span class="token punctuation">{</span> thread_id<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> messages<span class="token operator">?.</span>channel_values<span class="token operator">?.</span>messages <span class="token keyword">as</span> AIMessageChunk<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseService<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseService<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>
      list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token operator">:</span> item<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        role<span class="token operator">:</span> item<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        reasoning<span class="token operator">:</span> item<span class="token punctuation">.</span>additional_kwargs<span class="token operator">?.</span>reasoning_content<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="更改之后控制层的修改"><a href="#更改之后控制层的修改" class="header-anchor">#</a> 更改之后控制层的修改</h3> <div class="language-ts extra-class"><pre class="language-ts"><code>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createChatDto<span class="token operator">:</span> ChatDto<span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Res</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 流式传输的MIME类型</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> <span class="token string">'no-cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁用缓存</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Connection'</span><span class="token punctuation">,</span> <span class="token string">'keep-alive'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保持连接</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chatService<span class="token punctuation">.</span><span class="token function">streamCompletion</span><span class="token punctuation">(</span>createChatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>msg<span class="token punctuation">]</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
      <span class="token keyword">const</span> thinkMsg <span class="token operator">=</span> msg<span class="token punctuation">.</span>additional_kwargs<span class="token operator">?.</span>reasoning_content <span class="token operator">??</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>thinkMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">content</span><span class="token operator">:</span> thinkMsg<span class="token punctuation">,</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">'ai'</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'reasoning'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">content</span><span class="token operator">:</span> content<span class="token punctuation">,</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">'ai'</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'chat'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue-preess/config/three.html" class="prev">
        three
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vue-preess/assets/js/app.19476c11.js" defer></script><script src="/vue-preess/assets/js/2.f3b333de.js" defer></script><script src="/vue-preess/assets/js/1.f574d6f5.js" defer></script><script src="/vue-preess/assets/js/34.c2d25fb7.js" defer></script>
  </body>
</html>
